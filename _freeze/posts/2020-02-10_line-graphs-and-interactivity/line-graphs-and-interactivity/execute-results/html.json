{
  "hash": "c0513ce0d896006f3eeeee3c895e188e",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Line Graphs and Interactivity\"\nsubtitle: |\n  Tableau for Healthcare Chapter 10.  Static and Interactive examples\ndate: 02-10-2020\n---\n\nToday's post is all about line graphs using both ggplot for a static graph as well as a package called plotly for interactivity (more on this later). The example graph and data is again coming from Tableau for Healthcare, Chapter 10.  ![Example Line Graph](flu_surveillance.png)\n\n## Load Libraries\n\nAs always first step is to load in our libraries, I am using quite a few here, some are a bit overkill for this example but I wanted to play around with some fun features today.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(magrittr) #pipes\nlibrary(ggplot2) #ploting \nlibrary(dplyr)  # data manipulation\nlibrary(tidyr) # tidy data\nlibrary(lubridate) #work with dates\nlibrary(stringr) # manipulate strings\nlibrary(plotly)\n```\n:::\n\n\n## Import Data\n\nNext lets import our data, this week we are using the sheet Flu Occurrence FY2013-2016.  I am unsure if this is form a real data set or not but it is good for demonstration purposes!  After importing we can glimpse at our data to understand what is contained within.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nds <- readxl::read_xlsx(path = \"../2020-01-04_my-start-to-r/Tableau 10 Training Practice Data.xlsx\"\n                        ,sheet = \"05 - Flu Occurrence FY2013-2016\"\n                        )\nds %>% glimpse()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRows: 48\nColumns: 4\n$ Date                                         <dttm> 2012-10-27, 2012-11-24, …\n$ `Tests (+) for Influenza (count)`            <dbl> 995, 3228, 22368, 24615, …\n$ `Total Respiratory Specimens Tested (count)` <dbl> 18986, 24757, 66683, 7561…\n$ `% Tests (+) for Influenza`                  <dbl> 0.05240704, 0.13038737, 0…\n```\n\n\n:::\n:::\n\n\n## Transform Data\n\nI went a bit overboard today with renaming the variables.  I wanted to practice writing a function and while it might not be the prettiest or the best way to do this, it worked for what I was trying to accomplish. Note the use of sapply, which lets us run the function on each column name.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nformat_names <- function(x) {\n  #Fucntion to set all names to lower case, and strip unneeded characters\n  x <- tolower(x)\n  x <- str_replace_all(x,c(#set each pattern equal to replacement\n                       \" \"         = \"_\"\n                      ,\"\\\\(\\\\+\\\\)\" = \"pos\"  #regualr experssion to match (+)\n                      ,\"\\\\(\"       = \"\"\n                      ,\"\\\\)\"       = \"\"\n                      ,\"\\\\%\"       = \"pct\"\n                      )\n                  ) \n                }\n\n#run the format name function on all names from DS\ncolnames(ds) <- sapply(colnames(ds),format_names)    \n```\n:::\n\n\nNow is were the fun really starts!  For this particular data set there are a couple things we need to add to replicate the example.  In the original data set the date is stored with month, day, and year; the day is irrelevant and we need to pull out the month as well as the year.  For this we can use the lubridate package, first we pull out the month and set it as a factor.  For this example our year actually starts in October, so we set our factor to start at October (10), and end with September (9).  We then pull out the year, which presents us with a different problem.  Again our year starts in October, instead of January. To solve this I have created a variable called date adjustment, in this column is our month is 10 or greater, we will place a 1, if not a 0.  We then set our fiscal year to be the actual year plus the date adjustment, this allows us to have our dates in the right fiscal year.  Last the percent column is currently listed as a decimal, so we will convert this to a percentage.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# split date time\nds1 <- ds %>% mutate(\n        #create month column, then set factors and labels to start fiscal year in Oct\n        month = month(ds$date)\n        ,month = factor(month\n                        ,levels = c(10:12, 1:9)\n                        ,labels = c(month.abb[10:12],month.abb[1:9]))\n       ,year = year(ds$date)\n        ,date_adjustment = ifelse(month(ds$date) >= 10, 1,0 )\n        ,fiscal_year = factor(year + date_adjustment)\n        #convert % Pos from decmial to pct\n        ,pct_tests_pos_for_influenza = round(pct_tests_pos_for_influenza * 100, digits = 0)\n        )\n\nds1 %>% glimpse()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRows: 48\nColumns: 8\n$ date                                     <dttm> 2012-10-27, 2012-11-24, 2012…\n$ tests_pos_for_influenza_count            <dbl> 995, 3228, 22368, 24615, 1179…\n$ total_respiratory_specimens_tested_count <dbl> 18986, 24757, 66683, 75614, 5…\n$ pct_tests_pos_for_influenza              <dbl> 5, 13, 34, 33, 23, 17, 11, 6,…\n$ month                                    <fct> Oct, Nov, Dec, Jan, Feb, Mar,…\n$ year                                     <dbl> 2012, 2012, 2012, 2013, 2013,…\n$ date_adjustment                          <dbl> 1, 1, 1, 0, 0, 0, 0, 0, 0, 0,…\n$ fiscal_year                              <fct> 2013, 2013, 2013, 2013, 2013,…\n```\n\n\n:::\n:::\n\n\n## GGplot\n\nThe graph here is pretty straight forward with one exception, group!  For this line graph we want ggplot to connect the lines of the same year, if we do not explicitly state this using the group mapping, ggplot will try to connect all the lines together, which of course is not at all what we want!\n\n\n::: {.cell}\n\n```{.r .cell-code}\ng1 <- ds1 %>% \n    ggplot(aes(x = month, y = pct_tests_pos_for_influenza, color = fiscal_year\n               ,group = fiscal_year)) +\n  geom_line() +\n  labs(\n    x  = NULL\n    ,y = \"% Tests (+) for Influenza\"\n    ,color = NULL\n    ,title = \"Flu Viral Surveillance: % Respiratory Specimens Positive for Influenza \\nOctober - September \\nFor Flu Seasons 2013 - 2016\"\n  ) +\n  theme_classic() +\n  scale_y_continuous(breaks = seq(0,40,5)) +\n  scale_color_manual(values = c(\"#a6611a\",\"#dfc27d\",\"#80cdc1\",\"#018571\"))\n\ng1\n```\n\n::: {.cell-output-display}\n![](line-graphs-and-interactivity_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\n## plotly\n\nOne of the nice features of Tableau is the fact the graphs are interactive, while a good graph should speak for itself, end users love pretty things.  I have been experimenting with Plotly, which has an open source package for R (as well as many other programming languages!).  This example only just scratches the surface, but there will be many more to come!\n\n\n::: {.cell}\n\n```{.r .cell-code}\ng2 <- ds1 %>% \n    plot_ly(x = ~month, y = ~pct_tests_pos_for_influenza, type = \"scatter\", mode = \"lines\" \n            ,color = ~fiscal_year\n            ,colors = c(\"#a6611a\",\"#dfc27d\",\"#80cdc1\",\"#018571\")\n            , hoverinfo = 'y') %>% \n    layout(xaxis = list(\n                        title = \"\"\n                    )\n           ,yaxis = list(\n                        title = \"% Tests (+) for Influenza\"\n                    )\n           ,title = \"Flu Viral Surveillance: % Respiratory Specimens Positive for Influenza\"\n           ,legend = list(\n                      x = 100\n                      ,y = 0.5\n                      )   \n           \n           )\n\ng2\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"plotly html-widget html-fill-item\" id=\"htmlwidget-1cb78498fdb970f82be3\" style=\"width:100%;height:464px;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-1cb78498fdb970f82be3\">{\"x\":{\"visdat\":{\"36587dbd07c1\":[\"function () \",\"plotlyVisDat\"]},\"cur_data\":\"36587dbd07c1\",\"attrs\":{\"36587dbd07c1\":{\"x\":{},\"y\":{},\"mode\":\"lines\",\"hoverinfo\":\"y\",\"color\":{},\"colors\":[\"#a6611a\",\"#dfc27d\",\"#80cdc1\",\"#018571\"],\"alpha_stroke\":1,\"sizes\":[10,100],\"spans\":[1,20],\"type\":\"scatter\"}},\"layout\":{\"margin\":{\"b\":40,\"l\":60,\"t\":25,\"r\":10},\"xaxis\":{\"domain\":[0,1],\"automargin\":true,\"title\":\"\",\"type\":\"category\",\"categoryorder\":\"array\",\"categoryarray\":[\"Oct\",\"Nov\",\"Dec\",\"Jan\",\"Feb\",\"Mar\",\"Apr\",\"May\",\"Jun\",\"Jul\",\"Aug\",\"Sep\"]},\"yaxis\":{\"domain\":[0,1],\"automargin\":true,\"title\":\"% Tests (+) for Influenza\"},\"title\":\"Flu Viral Surveillance: % Respiratory Specimens Positive for Influenza\",\"legend\":{\"x\":100,\"y\":0.5},\"hovermode\":\"closest\",\"showlegend\":true},\"source\":\"A\",\"config\":{\"modeBarButtonsToAdd\":[\"hoverclosest\",\"hovercompare\"],\"showSendToCloud\":false},\"data\":[{\"x\":[\"Oct\",\"Nov\",\"Dec\",\"Jan\",\"Feb\",\"Mar\",\"Apr\",\"May\",\"Jun\",\"Jul\",\"Aug\",\"Sep\"],\"y\":[5,13,34,33,23,17,11,6,4,3,3,3],\"mode\":\"lines\",\"hoverinfo\":[\"y\",\"y\",\"y\",\"y\",\"y\",\"y\",\"y\",\"y\",\"y\",\"y\",\"y\",\"y\"],\"type\":\"scatter\",\"name\":\"2013\",\"marker\":{\"color\":\"rgba(166,97,26,1)\",\"line\":{\"color\":\"rgba(166,97,26,1)\"}},\"textfont\":{\"color\":\"rgba(166,97,26,1)\"},\"error_y\":{\"color\":\"rgba(166,97,26,1)\"},\"error_x\":{\"color\":\"rgba(166,97,26,1)\"},\"line\":{\"color\":\"rgba(166,97,26,1)\"},\"xaxis\":\"x\",\"yaxis\":\"y\",\"frame\":null},{\"x\":[\"Oct\",\"Nov\",\"Dec\",\"Jan\",\"Feb\",\"Mar\",\"Apr\",\"May\",\"Jun\",\"Jul\",\"Aug\",\"Sep\"],\"y\":[4,8,26,27,18,12,14,10,6,4,3,2],\"mode\":\"lines\",\"hoverinfo\":[\"y\",\"y\",\"y\",\"y\",\"y\",\"y\",\"y\",\"y\",\"y\",\"y\",\"y\",\"y\"],\"type\":\"scatter\",\"name\":\"2014\",\"marker\":{\"color\":\"rgba(223,194,125,1)\",\"line\":{\"color\":\"rgba(223,194,125,1)\"}},\"textfont\":{\"color\":\"rgba(223,194,125,1)\"},\"error_y\":{\"color\":\"rgba(223,194,125,1)\"},\"error_x\":{\"color\":\"rgba(223,194,125,1)\"},\"line\":{\"color\":\"rgba(223,194,125,1)\"},\"xaxis\":\"x\",\"yaxis\":\"y\",\"frame\":null},{\"x\":[\"Oct\",\"Nov\",\"Dec\",\"Jan\",\"Feb\",\"Mar\",\"Apr\",\"May\",\"Jun\",\"Jul\",\"Aug\",\"Sep\"],\"y\":[4,13,29,23,14,12,8,4,2,2,2,2],\"mode\":\"lines\",\"hoverinfo\":[\"y\",\"y\",\"y\",\"y\",\"y\",\"y\",\"y\",\"y\",\"y\",\"y\",\"y\",\"y\"],\"type\":\"scatter\",\"name\":\"2015\",\"marker\":{\"color\":\"rgba(128,205,193,1)\",\"line\":{\"color\":\"rgba(128,205,193,1)\"}},\"textfont\":{\"color\":\"rgba(128,205,193,1)\"},\"error_y\":{\"color\":\"rgba(128,205,193,1)\"},\"error_x\":{\"color\":\"rgba(128,205,193,1)\"},\"line\":{\"color\":\"rgba(128,205,193,1)\"},\"xaxis\":\"x\",\"yaxis\":\"y\",\"frame\":null},{\"x\":[\"Oct\",\"Nov\",\"Dec\",\"Jan\",\"Feb\",\"Mar\",\"Apr\",\"May\",\"Jun\",\"Jul\",\"Aug\",\"Sep\"],\"y\":[1,1,2,6,17,20,12,5,2,1,1,2],\"mode\":\"lines\",\"hoverinfo\":[\"y\",\"y\",\"y\",\"y\",\"y\",\"y\",\"y\",\"y\",\"y\",\"y\",\"y\",\"y\"],\"type\":\"scatter\",\"name\":\"2016\",\"marker\":{\"color\":\"rgba(1,133,113,1)\",\"line\":{\"color\":\"rgba(1,133,113,1)\"}},\"textfont\":{\"color\":\"rgba(1,133,113,1)\"},\"error_y\":{\"color\":\"rgba(1,133,113,1)\"},\"error_x\":{\"color\":\"rgba(1,133,113,1)\"},\"line\":{\"color\":\"rgba(1,133,113,1)\"},\"xaxis\":\"x\",\"yaxis\":\"y\",\"frame\":null}],\"highlight\":{\"on\":\"plotly_click\",\"persistent\":false,\"dynamic\":false,\"selectize\":false,\"opacityDim\":0.20000000000000001,\"selected\":{\"opacity\":1},\"debounce\":0},\"shinyEvents\":[\"plotly_hover\",\"plotly_click\",\"plotly_selected\",\"plotly_relayout\",\"plotly_brushed\",\"plotly_brushing\",\"plotly_clickannotation\",\"plotly_doubleclick\",\"plotly_deselect\",\"plotly_afterplot\",\"plotly_sunburstclick\"],\"base_url\":\"https://plot.ly\"},\"evals\":[],\"jsHooks\":[]}</script>\n```\n\n:::\n:::\n\n\n\n",
    "supporting": [
      "line-graphs-and-interactivity_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"../../site_libs/htmltools-fill-0.5.8.1/fill.css\" rel=\"stylesheet\" />\n<script src=\"../../site_libs/htmlwidgets-1.6.4/htmlwidgets.js\"></script>\n<script src=\"../../site_libs/plotly-binding-4.10.4/plotly.js\"></script>\n<script src=\"../../site_libs/typedarray-0.1/typedarray.min.js\"></script>\n<script src=\"../../site_libs/jquery-3.5.1/jquery.min.js\"></script>\n<link href=\"../../site_libs/crosstalk-1.2.1/css/crosstalk.min.css\" rel=\"stylesheet\" />\n<script src=\"../../site_libs/crosstalk-1.2.1/js/crosstalk.min.js\"></script>\n<link href=\"../../site_libs/plotly-htmlwidgets-css-2.11.1/plotly-htmlwidgets.css\" rel=\"stylesheet\" />\n<script src=\"../../site_libs/plotly-main-2.11.1/plotly-latest.min.js\"></script>\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}