{
  "hash": "2aabdba8b5fbcc9b3358c7ea09daf64d",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Does a US Born Players Birthdate affect their shot at the NHL\"\ndescription: \"Inspired by TidyTuesday Week 2 - 2024 dataset about Candian Players, lets look at the same anaylyis for American Born Players\"\ndate: \"6/08/2024\"  #Update when live\ncategories:\n  - tidytuesday\n  - R\n  - dataViz\n---\n\n\n\n\n::: {.cell}\n\n:::\n\n\nThis post is inspired by this fantastic [blog post](https://jlaw.netlify.app/2023/12/04/are-birth-dates-still-destiny-for-canadian-nhl-players/) on Jlaws Blog.  In it they explore how in the first chapter Malcolm Gladwell’s Outliers he discusses how in Canadian Junior Hockey there is a higher likelihood for players to be born in the first quarter of the year. As it appears cutoff dates for USA hockey are different and they are currently using June 1st (if my internet searches are to be believed), I wondered if the same analysis would hold true for American Born Players.\n\n## Distribution of Births by Month in the United States\n\nThe data for US Birth Rates can be pulled from [CDC Wonder](https://wonder.cdc.gov/). The particular table of interest is the Natality, 2007 - 2022.  CDC Wonder has a quite interesting API that requires a request with quite a few XML parameters.  Thankfully you can build the request on the website and a nice package already exists to send the query.  Check out the [Wonderapi Page](https://socdatar.github.io/wonderapi/index.html) for more info.  \n\n\n::: {.cell}\n\n```{.r .cell-code}\nusa_raw  <- wonderapi::send_query(\"D66\", here::here(\"posts\", \"2024-05-15-US-NHL-Birthrate\", \"cdc_wonder_request.xml\"))\n\nusa_births  <- usa_raw %>%\n  dplyr::group_by(Month) %>%\n  dplyr::summarise(country_births = sum(Births), .groups = \"drop\") %>%\n  dplyr::mutate(country_pct = country_births / sum(country_births))\n```\n:::\n\n\n### Distribution of Births Compared to Expected\n\nThe data from CDC Wonder pulls in quite nice, the only addition is adding a column for expected Births.  This column gives each day of each month an equal chance for a person being born.  Based on the data the summer months (June through August), and September have a slightly higher actual birth vs expected. Based on cut off Dates many of these kids would be the oldest in their age groups. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nusa_births %>%\n  dplyr::mutate(expected_births = dplyr::case_when(\n    Month %in% c(\"April\", \"June\", \"September\", \"November\") ~ 30 / 365\n    , Month == \"February\" ~ 28 / 365\n    , .default  = 31 / 365\n  )\n  , difference = country_pct - expected_births\n  , dplyr::across(Month, ~factor(., levels = month.name))\n  , dplyr::across(c(country_pct, expected_births, difference), ~scales::percent(., accuracy = .1))\n  ) %>%\n  dplyr::arrange(Month) %>%\n  dplyr::rename_with(~stringr::str_replace_all(., \"_\", \" \")) %>%\n  dplyr::rename_with(stringr::str_to_title) %>%\n  kableExtra::kbl() %>%\n  kableExtra::kable_styling()\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table\" style=\"margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> Month </th>\n   <th style=\"text-align:right;\"> Country Births </th>\n   <th style=\"text-align:left;\"> Country Pct </th>\n   <th style=\"text-align:left;\"> Expected Births </th>\n   <th style=\"text-align:left;\"> Difference </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> January </td>\n   <td style=\"text-align:right;\"> 5714814 </td>\n   <td style=\"text-align:left;\"> 8.2% </td>\n   <td style=\"text-align:left;\"> 8.5% </td>\n   <td style=\"text-align:left;\"> -0.3% </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> February </td>\n   <td style=\"text-align:right;\"> 5312730 </td>\n   <td style=\"text-align:left;\"> 7.6% </td>\n   <td style=\"text-align:left;\"> 7.7% </td>\n   <td style=\"text-align:left;\"> -0.1% </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> March </td>\n   <td style=\"text-align:right;\"> 5802947 </td>\n   <td style=\"text-align:left;\"> 8.3% </td>\n   <td style=\"text-align:left;\"> 8.5% </td>\n   <td style=\"text-align:left;\"> -0.2% </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> April </td>\n   <td style=\"text-align:right;\"> 5569772 </td>\n   <td style=\"text-align:left;\"> 8.0% </td>\n   <td style=\"text-align:left;\"> 8.2% </td>\n   <td style=\"text-align:left;\"> -0.3% </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> May </td>\n   <td style=\"text-align:right;\"> 5829368 </td>\n   <td style=\"text-align:left;\"> 8.3% </td>\n   <td style=\"text-align:left;\"> 8.5% </td>\n   <td style=\"text-align:left;\"> -0.2% </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> June </td>\n   <td style=\"text-align:right;\"> 5822605 </td>\n   <td style=\"text-align:left;\"> 8.3% </td>\n   <td style=\"text-align:left;\"> 8.2% </td>\n   <td style=\"text-align:left;\"> 0.1% </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> July </td>\n   <td style=\"text-align:right;\"> 6159421 </td>\n   <td style=\"text-align:left;\"> 8.8% </td>\n   <td style=\"text-align:left;\"> 8.5% </td>\n   <td style=\"text-align:left;\"> 0.3% </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> August </td>\n   <td style=\"text-align:right;\"> 6283330 </td>\n   <td style=\"text-align:left;\"> 9.0% </td>\n   <td style=\"text-align:left;\"> 8.5% </td>\n   <td style=\"text-align:left;\"> 0.5% </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> September </td>\n   <td style=\"text-align:right;\"> 6061915 </td>\n   <td style=\"text-align:left;\"> 8.7% </td>\n   <td style=\"text-align:left;\"> 8.2% </td>\n   <td style=\"text-align:left;\"> 0.4% </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> October </td>\n   <td style=\"text-align:right;\"> 5971630 </td>\n   <td style=\"text-align:left;\"> 8.5% </td>\n   <td style=\"text-align:left;\"> 8.5% </td>\n   <td style=\"text-align:left;\"> 0.0% </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> November </td>\n   <td style=\"text-align:right;\"> 5649999 </td>\n   <td style=\"text-align:left;\"> 8.1% </td>\n   <td style=\"text-align:left;\"> 8.2% </td>\n   <td style=\"text-align:left;\"> -0.1% </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> December </td>\n   <td style=\"text-align:right;\"> 5831907 </td>\n   <td style=\"text-align:left;\"> 8.3% </td>\n   <td style=\"text-align:left;\"> 8.5% </td>\n   <td style=\"text-align:left;\"> -0.2% </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n## Hockey Data\n\nWhile I wish I could sit and type out how I sat and figured out the complexity of the NHL Stats API and how to bring it into R.  In reality I took a great guide, that being Jlaws post, and tweaked what I needed.  Instead of Canadian players, I pulled out just the US Born players and their birth dates. I did also pull out positions to see if that will make any sort of difference.  What pulls out of the NHL API has a ton of great details and I look forward to diving into what is available to see what kind of graphics can be built.  \n\n**08/27/2024 Update** Due to the the Coyotes moving to Utah, I had to edit the code slightly to adjust for this.  When gathering the active roster data the API was returning a blank response.  This was causing Tidyr Hoist to fail because it could not pull the columns from the nested data frame.  I added a check to see if the data frame is empty and if it is, then I return an empty data frame and skip this step.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nteams <- httr::GET(\"https://api.nhle.com/stats/rest/en/team\") %>%\n  httr::content() %>%\n  .[[\"data\"]] %>%\n  tibble::tibble(data = .) %>%\n  tidyr::unnest_wider(data)\n\nget_roster  <- function(team){\n  df  <- httr::GET(glue::glue(\"https://api-web.nhle.com/v1/roster/{team}/20232024\")) %>%\n    httr::content() %>%\n    purrr::flatten() %>%\n    tibble::tibble(data = .)\n\n  if (!nrow(df) == 0) {\n    df  <- df |>\n      tidyr::hoist(\n        .col = \"data\"\n        , \"firstName\" = list(\"firstName\", 1L)\n        , \"lastName\" = list(\"lastName\", 1L)\n        , \"positionCode\"\n        , \"birthDate\"\n        , \"birthCountry\"\n      )\n  }\n  return(df)\n}\n\nusa_roster  <- purrr::map(teams$triCode, get_roster) %>%\n  purrr::list_rbind() %>%\n  dplyr::filter(!is.na(firstName)) %>%\n  dplyr::filter(birthCountry == \"USA\") %>%\n  dplyr::mutate(\n    mob = lubridate::month(lubridate::ymd(birthDate), label = TRUE, abbr = FALSE)\n    , mob_id = lubridate::month(lubridate::ymd(birthDate))\n  ) %>%\n  dplyr::count(mob_id, mob,  name = \"players\") %>%\n  dplyr::mutate(player_pct = players / sum(players))\n```\n:::\n\n\n\n## Graph It \n\nLets now take a look at the graph.  Using the ggimage package we can place nice logos for both the United States and NHL on the graph.  This stands out quite nicely versus just using a colored point.  Interesting enough the graph seems to show being born early on in the year may mean making the NHL is more likely.  \n\n\n::: {.cell}\n\n```{.r .cell-code}\nnhl_icon  <- \"https://pbs.twimg.com/media/F9sTTAYakAAkRv6.png\"\nusa_icon  <- \"https://cdn-icons-png.flaticon.com/512/197/197484.png\"\n\ncombined  <- usa_roster %>%\n  dplyr::left_join(usa_births, by = c(\"mob\" = \"Month\")) %>%\n  dplyr::mutate(\n    random = dplyr::case_when(\n      mob_id %in% c(4, 6, 9, 11) ~ 30 / 365,\n      mob_id %in% c(1, 3, 5, 7, 8, 10, 12) ~ 31 / 365,\n      mob_id == 2 ~ 28 / 365\n    )\n  )\n\n# labels  <- combined %>% glue::glue_data(\"{mob} <br> n = {players}\")\n\ng1  <- combined %>%\n  ggplot(aes(x = forcats::fct_reorder(mob, -mob_id))) +\n  geom_line(aes(y = random, group = 1), linetype = 2, color = \"grey60\") +\n  geom_linerange(aes(ymin = country_pct, ymax = player_pct)) +\n  geom_image(aes(image = nhl_icon, y = player_pct), size = 0.1) +\n  geom_image(aes(image = usa_icon, y = country_pct), size = 0.08) +\n  geom_text(aes(label = scales::percent(player_pct, accuracy = .1),\n      y = dplyr::if_else(player_pct > country_pct, player_pct + .006, player_pct - .006)), size = 5) +\n  geom_text(aes(label = scales::percent(country_pct, accuracy = .1),\n      y = dplyr::if_else(country_pct > player_pct, country_pct + .006, country_pct - .006)), size = 5) +\n  scale_y_continuous(labels = scales::percent) +\n  # scale_x_discrete(labels = labels) +\n  coord_flip() +\n  labs(\n    x = \"Month of Birth\"\n    , y = \"Percentage of Births\"\n    , title = \"Are United States Born NHL Players More Likely to be Born Early in the Year?\"\n    , subtitle = \"Comparing the distribution of birth months between US NHL players and US in general\"\n    , caption = glue::glue(\n      \"<img src = {nhl_icon} width = '15' height=' 15' /> - US NHL Players Birth Month Distribution <br />\n      <img src = {usa_icon} width = '15' height=' 15' /> - US Birth Month (2007-2022) Distribution\"\n    )\n  ) +\n  theme_minimal() +\n  theme(\n    plot.caption = element_markdown()\n    , plot.title.position = \"plot\"\n    , text = element_text(size = 16)\n    , axis.text = element_markdown()\n  )\n\n\ng1\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/Graph_It-1.png){width=960}\n:::\n\n```{.r .cell-code}\n# Stats ----\n\nbroom::tidy(chisq.test(x = combined$players, p = combined$country_pct))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 1 × 4\n  statistic p.value parameter method                                  \n      <dbl>   <dbl>     <dbl> <chr>                                   \n1      7.31   0.773        11 Chi-squared test for given probabilities\n```\n\n\n:::\n:::\n\n\nIf we look at this from a more stats based perspective, running a chi square test on the amount of players in the NHL per month, based on the US expected birth rate, we do see however there is quite a high p value.  This is lets us know we can not reject the Null hypothesis that these are the same thing. \n\n\n::: {.cell}\n\n:::\n\n\n# A Little Fun\n\nFor just a little bit of fun I pulled birth data for the entire world using the UN's website.  I then filtered this out to just countries that currently have players in the NHL.  The graph shows more of the same, looks to lean heavily to the beginning of the year, and this time the stat back it up.  So being born early in the year may in fact help your chances of making it to the NHL  \n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ng2  <- combined_world %>%\n  ggplot(aes(x = forcats::fct_reorder(mob, -mob_id))) +\n  geom_line(aes(y = random, group = 1), linetype = 2, color = \"grey60\") +\n  geom_linerange(aes(ymin = world_pct, ymax = player_pct)) +\n  geom_image(aes(image = world_icon, y = world_pct), size = 0.08) +\n  geom_image(aes(image = nhl_icon, y = player_pct), size = 0.1) +\n  geom_text(aes(label = scales::percent(player_pct, accuracy = .1),\n      y = dplyr::if_else(player_pct > world_pct, player_pct + .006, player_pct - .006)), size = 5) +\n  geom_text(aes(label = scales::percent(world_pct, accuracy = .1),\n      y = dplyr::if_else(world_pct > player_pct, world_pct + .006, world_pct - .006)), size = 5) +\n  scale_y_continuous(labels = scales::percent) +\n  coord_flip() +\n  labs(\n    x = \"Month of Birth\"\n    , y = \"Percentage of Births\"\n    , title = \"What Birthday is most liekly to make the NHL?\"\n    , subtitle = \"Comparing the distribution of birth months between All NHL players and the World in general\"\n    , caption = glue::glue(\n      \"<img src = {nhl_icon} width = '15' height=' 15' /> - US NHL Players Birth Month Distribution <br />\n      <img src = {world_icon} width = '15' height=' 15' /> - World Birth Month (2007-2022) Distribution\"\n    )\n  ) +\n  theme_minimal() +\n  theme(\n    plot.caption = element_markdown()\n    , plot.title.position = \"plot\"\n    , text = element_text(size = 16)\n    , axis.text = element_markdown()\n  )\n\ng2\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/world_graph-1.png){width=960}\n:::\n\n```{.r .cell-code}\nbroom::tidy(chisq.test(x = combined_world$players, p = combined_world$world_pct))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 1 × 4\n  statistic p.value parameter method                                  \n      <dbl>   <dbl>     <dbl> <chr>                                   \n1      28.8 0.00243        11 Chi-squared test for given probabilities\n```\n\n\n:::\n:::\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"../../site_libs/kePrint-0.0.1/kePrint.js\"></script>\n<link href=\"../../site_libs/lightable-0.0.1/lightable.css\" rel=\"stylesheet\" />\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}